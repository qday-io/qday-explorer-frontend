name: Create and publish Testnet Docker image

on:
  push:
    branches:
      - current

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: qday-io/explorer-frontend

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get git info
        id: git-info
        run: |
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      - name: Free disk space before build
        run: |
          echo "Disk space before cleanup:"
          df -h
          # Remove unnecessary packages and clean up
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
          # Clean Docker system
          docker system prune -af --volumes || true
          # Clean package manager caches
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          echo "Disk space after cleanup:"
          df -h

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            GIT_COMMIT_SHA=${{ steps.git-info.outputs.commit_sha }}
            GIT_TAG=${{ steps.git-info.outputs.tag }}
            ENVS_PRESET=qday_testnet
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:testnet
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:testnet-${{ steps.git-info.outputs.date }}

      - name: Clean up after build
        if: always()
        run: |
          echo "Disk space after build:"
          df -h
          # Clean up Docker build cache
          docker builder prune -af || true
          echo "Final disk space:"
          df -h